<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Aplikacja konsolowa w .NET Core | DevOops adventures</title><meta property="og:title" content="Aplikacja konsolowa w .NET Core | DevOops adventures"><meta name=twitter:title content="Aplikacja konsolowa w .NET Core | DevOops adventures"><meta itemprop=name content="Aplikacja konsolowa w .NET Core | DevOops adventures"><meta name=application-name content="Aplikacja konsolowa w .NET Core | DevOops adventures"><meta property="og:site_name" content="DevOops adventures"><meta name=description content="Konfiguracja, logowanie i dependency injection"><meta itemprop=description content="Konfiguracja, logowanie i dependency injection"><meta property="og:description" content="Konfiguracja, logowanie i dependency injection"><meta name=twitter:description content="Konfiguracja, logowanie i dependency injection"><meta property="og:locale" content="en-us"><meta name=language content="en-us"><meta itemprop=image content="https://ksmigiel.com/"><meta property="og:image" content="https://ksmigiel.com/"><meta name=twitter:image content="https://ksmigiel.com/"><meta name=twitter:image:src content="https://ksmigiel.com/"><meta property="og:type" content="article"><meta property="og:article:published_time" content="2018-01-18T13:13:09Z"><meta property="article:published_time" content="2018-01-18T13:13:09Z"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Aplikacja konsolowa w .NET Core","author":{"@type":"Person","name":""},"datePublished":"2018-01-18","description":"Konfiguracja, logowanie i dependency injection","wordCount":542,"mainEntityOfPage":"True","dateModified":"2018-01-18","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"DevOops adventures"}}</script><meta name=generator content="Hugo 0.115.3"><link rel=canonical href=https://ksmigiel.com/posts/netcore-console/><link href=/style.min.568461389d4f5a5d530aa6959cf73913ca381c41a672b5ad8888ceeb5bfa6473.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://ksmigiel.com/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg></head><body data-theme=dark class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://ksmigiel.com/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class="menu-link active" href=/posts/>Posts</a></li><li><a class=menu-link href=/about/>About</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>Aplikacja konsolowa w .NET Core</h1><div class=post-meta><time datetime=2018-01-18T13:13:09+00:00 itemprop=datePublished>18 Jan 2018</time></div></header><div class=page-content><p>Zapewne dla tych, którzy mieli styczność z frameworkiem ASP.NET Core zagadnienia takie jak pliki konfiguracyjne projektu, logowanie zdrarzeń i dependency injection nie są żadną nowością. Cała filozofia nowego ASP.NET opiera się na DI i modułowości, a większość poradników właśnie od tego zaczyna.</p><p>Ponieważ ostatnio dużo eksperymentuję z .NET Core i Visual Studio Code postanowiłem sprawdzić, czy klasy używane w ASP.NET Core są re-używalne w aplikacji konsolowej.</p><p>Okazuje się, że istnieje skończona kombinacja paczek NuGet&rsquo;owych pozwalająca uzyskać taką samą funkcjonalność - zawdzięczamy to architekturze ASP.NET Core, który jest frameworkiem złożonym z niezależnych komponentów.</p><h2 id=pliki-konfiguracyjne>Pliki konfiguracyjne</h2><p>W klasycznej wersji .NET korzystaliśmy z plików XML <code>*.config</code> i klas <code>ConfigurationManager</code> czy <code>Configuration</code>. W przypadku .NET Core do przechowywania konfiguracji domyślnie stosowany jest format JSON. Spójrzmy na przykładowy kawałek kodu.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.IO</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>Microsoft.Extensions.Configuration</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>Configuration</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>sealed</span> <span class=k>class</span> <span class=nc>AppConfiguration</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>readonly</span> <span class=n>IConfigurationRoot</span> <span class=n>_configuration</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=n>AppConfiguration</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>_configuration</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ConfigurationBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>SetBasePath</span><span class=p>(</span><span class=n>Directory</span><span class=p>.</span><span class=n>GetCurrentDirectory</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>AddJsonFile</span><span class=p>(</span><span class=s>&#34;appsettings.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>Build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=n>IConfigurationRoot</span> <span class=n>Configuration</span> <span class=p>=&gt;</span> <span class=n>_configuration</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Główną rolę odgrywa tutaj namespace <code>Microsoft.Extensions.Configuration</code>. Niestety poza ASP.NET Core musimy sami zadbać o ściągnięcie odpowiednich paczek z <em>extension methods</em>, których chcemy użyć.
Tak więc do naszego .csproj&rsquo;a musimy wrzucić: (lub z linii komend odpalić <code>dotnet add package &lt;PACKAGE_NAME></code>)</p><pre tabindex=0><code>&lt;PackageReference Include=&#34;Microsoft.Extensions.Configuration&#34; Version=&#34;2.0.0&#34; /&gt;
&lt;!-- SetBasePath() --&gt;
&lt;PackageReference Include=&#34;Microsoft.Extensions.Configuration.FileExtensions&#34; Version=&#34;2.0.0&#34; /&gt;
&lt;!-- AddJsonFile() --&gt;
&lt;PackageReference Include=&#34;Microsoft.Extensions.Configuration.Json&#34; Version=&#34;2.0.0&#34; /&gt;
</code></pre><p>Plik <code>appsettings.json</code> może zawierać m.in. konfigurację logowania. W <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/?tabs=aspnetcore2x">dokumentacji</a> znajdziesz wiele przydatynch informacji o logowaniu, do którego zaraz zresztą przejdziemy.</p><pre tabindex=0><code>{
    &#34;Logging&#34;: {
        &#34;IncludeScopes&#34;: true,
        &#34;LogLevel&#34;: {
            &#34;Default&#34;: &#34;Debug&#34;
        }
    }
}
</code></pre><h2 id=logowanie>Logowanie</h2><p>Dodanie logowania do aplikacji ociera się już o wstrzykiwanie zależności.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kt>var</span> <span class=n>appConfiguration</span> <span class=p>=</span> <span class=k>new</span> <span class=n>AppConfiguration</span><span class=p>();</span> <span class=c1>// (1)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>services</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ServiceCollection</span><span class=p>();</span> <span class=c1>//        (2)</span>
</span></span><span class=line><span class=cl><span class=n>services</span><span class=p>.</span><span class=n>AddLogging</span><span class=p>((</span><span class=n>builder</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=c1>//               (3)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>AddConfiguration</span><span class=p>(</span><span class=n>appConfiguration</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>GetSection</span><span class=p>(</span><span class=s>&#34;Logging&#34;</span><span class=p>))</span> <span class=c1>// (4)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>AddConsole</span><span class=p>()</span> <span class=c1>//                                                           (5)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>AddDebug</span><span class=p>();</span> <span class=c1>//                                                            (6)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>Przeanalizujmy co się tutaj podziało. Tworzymy konfigurację przy pomocy poprzednio omówionej klasy (1). Tworzymy nowy kontener DI (2). Do kontenera dodajemy logowanie (3). Konfigurujemy logowanie przy pomocy naszej klasy konfiguracyjnej (4) i ustawiamy wyjście loggera na konsolę (5) i okno debug (6).</p><p>Aby kod się kompilował musimy dodać kolejne paczki NuGet:</p><pre tabindex=0><code>&lt;!-- ServiceCollection() --&gt;
&lt;PackageReference Include=&#34;Microsoft.Extensions.DependencyInjection&#34; Version=&#34;2.0.0&#34; /&gt;
&lt;!-- AddLogging() --&gt;
&lt;PackageReference Include=&#34;Microsoft.Extensions.Logging&#34; Version=&#34;2.0.0&#34; /&gt;
&lt;!-- AddConfiguration() --&gt;
&lt;PackageReference Include=&#34;Microsoft.Extensions.Logging.Configuration&#34; Version=&#34;2.0.0&#34; /&gt;
&lt;!--  AddConsole() --&gt;
&lt;PackageReference Include=&#34;Microsoft.Extensions.Logging.Console&#34; Version=&#34;2.0.0&#34; /&gt;
&lt;!-- AddDebug() --&gt;
&lt;PackageReference Include=&#34;Microsoft.Extensions.Logging.Debug&#34; Version=&#34;2.0.0&#34; /&gt;
</code></pre><p>Pozostało nam jedynie zarejestrować odpowiednie komponenty w kontenerze DI i gotowe!</p><h2 id=dependency-injection>Dependency Injection</h2><p>W tym momencie do stworzonej instancji <code>ServiceCollection</code> musimy dodać potrzebne zależności. Posłużą nam do tego metody:</p><ul><li><code>AddTransient()</code> - instancja tworzona za każdym razem</li><li><code>AddScoped()</code> - instancja tworzona per request</li><li><code>AddSingleton()</code> - jedna instancja</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>services</span><span class=p>.</span><span class=n>AddSingleton</span><span class=p>&lt;</span><span class=n>AppConfiguration</span><span class=p>&gt;(</span><span class=n>appConfiguration</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>services</span><span class=p>.</span><span class=n>AddTransient</span><span class=p>&lt;</span><span class=n>Server</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>container</span> <span class=p>=</span> <span class=n>services</span><span class=p>.</span><span class=n>BuildServiceProvider</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>server</span> <span class=p>=</span> <span class=n>container</span><span class=p>.</span><span class=n>GetService</span><span class=p>&lt;</span><span class=n>Server</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl><span class=n>server</span><span class=p>.</span><span class=n>Start</span><span class=p>();</span>
</span></span></code></pre></div><p>W tym momencie w klasie <code>Server</code> możemy wstrzykiwać zależności przez konstruktor.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>Server</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=n>IConfigurationRoot</span> <span class=n>_configuration</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=n>ILogger</span> <span class=n>_logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>Server</span><span class=p>(</span><span class=n>ILoggerFactory</span> <span class=n>loggerFactory</span><span class=p>,</span> <span class=n>AppConfiguration</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_logger</span> <span class=p>=</span> <span class=n>loggerFactory</span><span class=p>.</span><span class=n>CreateLogger</span><span class=p>&lt;</span><span class=n>Server</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>_configuration</span> <span class=p>=</span> <span class=n>configuration</span><span class=p>.</span><span class=n>Configuration</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>ILoggerFactory</code> jest automatycznie zarejestrowany w kontenerze poprzez wcześniejszą rejestrację <code>services.AddLogging(...)</code>.</p><h2 id=podsumowanie>Podsumowanie</h2><p>Jak widać .NET Core udostępnia wiele gotowych rozwiązań, dzięki czemu nie musimy korzystać z bibliotek third-party. Oczywiście nic nie stoi na przeszkodzie, aby do logowania podpiąć <a href=https://github.com/serilog/serilog-extensions-logging>Serilog</a>, a zależności rozwiązać <a href=http://autofaccn.readthedocs.io/en/latest/integration/netcore.html>Autofac&rsquo;iem</a>. Wszystko zależy od przypadku użycia, aczkolwiek dla małych projektów rozwiązania od teamu .NET Core wydają się całkiem sensowne.</p><p>Cały kod z przykładów możecie znaleźć na moim <a href=https://github.com/ksmigiel/SSHServer>GitHub</a>.</p><hr><ol><li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/?tabs=aspnetcore2x">https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/?tabs=aspnetcore2x</a></li><li><a href=https://github.com/serilog/serilog-extensions-logging>https://github.com/serilog/serilog-extensions-logging</a></li><li><a href=http://autofaccn.readthedocs.io/en/latest/integration/netcore.html>http://autofaccn.readthedocs.io/en/latest/integration/netcore.html</a></li><li><a href=https://github.com/ksmigiel/SSHServer>https://github.com/ksmigiel/SSHServer</a></li></ol></div></article></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/ksmigiel target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.linkedin.com/in/ksmigiel/ target=_blank rel="noopener noreferrer me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=index.xml target=_blank rel="noopener noreferrer me" title=Rss><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel="noreferrer noopener">Hugo blog awesome</a>
theme on
<a href=https://gohugo.io target=_blank rel="noreferrer noopener">Hugo</a>.</small></footer><a href=# title="Go to top" id=totop><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentcolor" stroke="currentcolor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg></a><script src=https://ksmigiel.com/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>